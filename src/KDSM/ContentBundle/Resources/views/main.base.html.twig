{% extends 'base.html.twig' %}
{% block stylesheets %}
    <link rel="stylesheet" type="text/css" href="{{ asset('bundles/kdsmcontent/css/main.css') }}" />
    {% stylesheets 'bundles/kdsmcontent/css/*' filter='cssrewrite' %}
    <link rel="stylesheet" type="text/css" href="{{ asset_url }}" />
    {% endstylesheets %}
    {# Fonts #}
    <link rel="stylesheet" type="text/css" href="{{ asset('bundles/kdsmcontent/css/font-awesome.css') }}" />
    <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Open+Sans:400,300, 700, 900&amp;subset=latin,latin-ext">
{% endblock %}
{% block body %}
    <div class="container-fluid">
        {% if not app.user %}
        {% block header %}
            <header class="row">
                <div class="container">
                    <img class="col-sm-3 logo" src="{{ asset('bundles/kdsmcontent/images/logotype.png') }}" alt=""/>
                    <div class="col-sm-7">
                        <div class="nav row">

                        </div>
                    </div>
                </div>
            </header>
        {% endblock %}
        {% endif %}
        <div class="row">
            {% block sidebar %}
                {% if app.user %}
                     {{ include('KDSMContentBundle::Includes/sidebar.html.twig') }}
                {% endif %}
            {% endblock %}
            <main class="main-content {% if not app.user %} container {% else %} col-sm-8 after-fixed-sidebar {% endif %}">
                {% block content %}

                {% endblock %}
            </main>
            {% block rightSidebar %}
                {% if app.user %}
                    <aside class="col-sm-2 sidebar right">
                        <div class="ui-widget search-box">
                            <i class="search-users-icon glyphicon glyphicon-search"></i>
                            <input id="search-users" placeholder="Search...">
                        </div>
                        <div id="results" class="found-users"></div>
                        <div class="ui-widget selected-users">
                            <h5>Pasirinkti žaidėjai:</h5>
                            <div id="log" class="ui-widget-content">
                                <ul class="log-list">

                                </ul>
                            </div>
                        </div>
                    </aside>
                {% endif %}
            {% endblock %}
        </div>
    </div>
{% endblock %}
{% block javascripts %}
    {# jQuery include#}
    {% javascripts '@KDSMContentBundle/Resources/public/jquery.js' %}
        <script src="{{ asset_url }}"></script>
    {% endjavascripts %}
    {# Others js files includes#}
    {% javascripts '@KDSMContentBundle/Resources/public/js/*' %}
        <script src="{{ asset_url }}"></script>
    {% endjavascripts %}
    <script type="text/javascript">
        $(document).ready(function() {
            var availableTags = [{"id":"32","value":"Text"},{"id":"62","value":"Text2"},{"id":"68","value":"Text3"},{"id":"61","value":"Text4"}] ;

            var selectedUsersNum = 0;
            var selectedUsersIds = [];

            //when needs to disselect user
            $("#log").on("click", "li", function() {
                selectedUsersNum--;
                var removedUserRow = $(this);
                var removedRowIdTag = removedUserRow.attr("id");
                var removedUserId = removedUserRow.attr("user-id");
                selectedUsersIds.splice(selectedUsersIds.indexOf(removedUserId), 1);
                $(this).remove();
                //get back user to list
                $(".sidebar").find("li#"+removedRowIdTag).show();
            });

            $( "#search-users" ).autocomplete({
                source: availableTags,
                create: function( event, ui ) {
                    $(this).autocomplete("widget")
                            .appendTo("#results")
                            .css("position", "static");
                },
                open: function() {
                    $(this).autocomplete("widget")
                            .appendTo("#results")
                            .css("position", "static");
                },
                select: function(event, ui) {
                    //when user is selected
                    if(selectedUsersNum < 3) {
                        selectedUsersNum++;
                        selectedUsersIds.push(ui.item.id);
                        var selectedUserRow = $(event.toElement.outerHTML);
                        var selectedRowIdTag = selectedUserRow.attr("id");
                        selectedUserRow.removeClass("ui-state-focus");
                        selectedUserRow.attr("user-id",ui.item.id);
                        $("li#"+selectedRowIdTag).hide();
                        $("#log").children("ul.log-list").prepend(selectedUserRow);
                    }

                    //if ateleast one user is selected, add button to save the queue
                    if(selectedUsersNum >= 1) {
                        var saveButtonHtml = '<button id="save-queue-element" class="btn btn-xs btn-success">Išsaugoti</button>';
                        $("#log").append(saveButtonHtml);
                    }

                    //Add game to queue
                    var canAddGame = ($(".queue-container").children("div.appended").length) == 0 ? true: false;
                    if(canAddGame) {
                        $(".queue-container").append('<div class="row queue-game appended">' +
                        '<div class="col-sm-5">' +
                        '<div class="row">' +
                        '<img class="col-sm-3 img-responsive" src="/KDSM/web/bundles/kdsmcontent/images/empty-user.jpg" alt="">' +
                        '<span class="col-sm-6 text-center">Dainius &amp; Jonas</span>' +
                        '<img class="col-sm-3 img-responsive" src="/KDSM/web/bundles/kdsmcontent/images/empty-user.jpg" alt="">' +
                        '</div>' +
                        '</div>' +
                        '<div class="col-sm-2">' +
                        '<div class="row">' +
                        '<p>VS</p>' +
                        '</div>' +
                        '</div>' +
                        '<div class="col-sm-5">' +
                        '<div class="row">' +
                        '<img class="col-sm-3 img-responsive" src="/KDSM/web/bundles/kdsmcontent/images/empty-user.jpg" alt="">' +
                        '<span class="col-sm-6 text-center">Rokas &amp; Tomas</span>' +
                        '<img class="col-sm-3 img-responsive" src="/KDSM/web/bundles/kdsmcontent/images/empty-user.jpg" alt="">' +
                        '</div>' +
                        '</div>' +
                        '</div>');
                    }
                }
            });
            $("#log").on("click", "button#save-queue-element", function() {
                $.ajax({
                    type: "post",
                    url: "{{ path('ksdm_live_game') }}",
                    data: { usersIds: selectedUsersIds },
                    success: function (response) {
                        alert(response);
                    }
                });
            });
        });
    </script>
    <script type="text/javascript">
        $(document).ready(function() {
            setInterval(TableData, 2000);
            function TableData() {
                $.ajax({
                    type: "post",
                    url: "{{ path('ksdm_live_game') }}",
                    success: function (response_json) {
                        var response = $.parseJSON(response_json);
                        if (response.status == 'free') {
                            $("div.result-box").addClass("hidden");
                            $("div.table-free").removeClass("hidden");
                        }
                        else if (response.status == 'busy') {
                            $("span.result.white").text(response.scoreWhite);
                            $("span.result.black").text(response.scoreBlack);
                            $("div.result-box").removeClass("hidden");
                            $("div.table-free").addClass("hidden");
                        }
                    }
                });
            }
        });
    </script>

    <script type="text/javascript">
        $(document).ready(function(){
            var userid = {{ app.user.id }};
            setInterval( reloadNotifications, 2000);
            function reloadNotifications(){
                $.ajax({
                    type: "post",
                    url: "{{ path('get_notifications') }}",
                    data: {id: userid},
                    success: function(response_json) {
                        $("ul#notifications").empty();
                        var response = $.parseJSON(response_json);
                        $('#notification-count').html(response.length);
                        $.each(response, function(key, value){
                            $("ul#notifications").append(
                                    $('<li>').append(
                                            $('<a>').attr('href', '#').attr('id', 'notification-'.concat(value.id)).attr('onclick','viewNotification(this)').append(value.notificationText)
                                    )
                            );
                        });
                    }
                });
            }
        });
    </script>

    <script>
        function viewNotification(element){
            var notificationid = element.id.substr(13);
            $.ajax({
                type: "post",
                url: "{{ path('view_notification') }}",
                data: {id: notificationid}
//                success: function(){
//                    $(element).remove();
//                    $('#notification-count').html(parseInt($('#notification-count').val())-1);
//                }
            });
        }

    </script>
{% endblock %}